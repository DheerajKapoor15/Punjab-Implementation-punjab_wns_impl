#!/bin/bash
export PATH=/home/ubuntu/bin:/home/ubuntu/.local/bin:/usr/share/jdk1.8.0_131/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin

export JDBC_IMPORTER_HOME=/home/ubuntu/feeder/elasticsearch-jdbc-2.3.4.1
export ES_HOME=/home/ubuntu/feeder/elasticsearch-jdbc-2.3.4.1
bin=$JDBC_IMPORTER_HOME/bin
lib=$JDBC_IMPORTER_HOME/lib

echo '
{
"type": "jdbc",
"jdbc": {
"url": "jdbc:postgresql://punjab-prod-rds.c7gelbottzkp.ap-south-1.rds.amazonaws.com:5432/punjab_prod_app",
"user": "punjab_prod_user",
"password": <input db user password here>,
"strategy": "standard",
"timezone": "localtime",
"sql": "select (select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"_id\", DATE(ch.createddate) as \"createdDate\", ch.receiptNumber as \"receiptNumber\", billingservice.name as \"billingService\", it.type as \"paymentMode\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ARREAR_AMOUNT\u0027) as \"arrearAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_LATEPAYMENT_CHARGES\u0027,\u0027CURRENT_LATEPAYMENT_CHARGES\u0027)) as \"latePaymentCharges\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_PENALTY_CHARGES\u0027,\u0027CURRENT_PENALTY_CHARGES\u0027)) as \"interestAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027CURRENT_AMOUNT\u0027) as \"currentAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ADVANCE_AMOUNT\u0027) as \"advanceAmount\",ch.totalamount as \"totalAmount\", ch.source as \"channel\",\u0027\u0027 as \"paymentGateway\",ch.referencenumber as \"billNumber\", ch.consumercode as \"consumerCode\", (select name from '"$1"'.eg_city) as \"cityName\", (select districtname from '"$1"'.eg_city) as \"districtName\", (select regionname from '"$1"'.eg_city) as \"regionName\",status.description as \"status\",DATE(ch.receiptdate) as \"receiptDate\",(select trim(\u0027Water Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber= (select min(ordernumber) from '"$1"'.egcl_collectiondetails where collectionheader=ch.id)) as \"installmentFrom\", (select trim(\u0027Water Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber=(select max(ordernumber) from '"$1"'.egcl_collectiondetails where cramount>0 and collectionheader=ch.id)) as \"installmentTo\",ch.payeename as \"consumerName\", (select grade from '"$1"'.eg_city) as \"cityGrade\", (select code from '"$1"'.eg_city) as \"cityCode\", eu.name as \"receiptCreator\",(select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"id\", block.name as \"block\", locality.name as \"locality\" , ch.consumertype as \"consumerType\" from '"$1"'.egcl_collectionheader ch, '"$1"'.egcl_servicedetails billingservice, '"$1"'.egcl_collectioninstrument ci, '"$1"'.egf_instrumentheader ih, '"$1"'.egf_instrumenttype it, '"$1"'.egw_status status, '"$1"'.eg_user eu,  '"$1"'.eg_boundary locality, '"$1"'.eg_boundary block, '"$1"'.egwtr_connection wtrcon where billingservice.id=ch.servicedetails and ci.collectionheader=ch.id and ci.instrumentheader=ih.id and ih.instrumenttype=it.id and ch.status=status.id and ch.collectiontype in (\u0027C\u0027,\u0027F\u0027) and billingservice.code=\u0027WT\u0027 and wtrcon.consumercode=ch.consumercode and ch.createdby=eu.id and ch.status in (select id from '"$1"'.egw_status where moduletype=\u0027ReceiptHeader\u0027 and code not in (\u0027PENDING\u0027,\u0027FAILED\u0027)) and locality.id=wtrcon.locality and block.id=wtrcon.block UNION select (select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"_id\", DATE(ch.createddate) as \"createdDate\", ch.receiptNumber as \"receiptNumber\",billingservice.name as \"billingService\", it.type as \"paymentMode\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ARREAR_AMOUNT\u0027) as \"arrearAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_LATEPAYMENT_CHARGES\u0027,\u0027CURRENT_LATEPAYMENT_CHARGES\u0027)) as \"latePaymentCharges\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_PENALTY_CHARGES\u0027,\u0027CURRENT_PENALTY_CHARGES\u0027)) as \"interestAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027CURRENT_AMOUNT\u0027) as \"currentAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ADVANCE_AMOUNT\u0027) as \"advanceAmount\", ch.totalamount as \"totalAmount\",ch.source as \"channel\",paymentservice.name as \"paymentGateway\",ch.referencenumber as \"billNumber\", ch.consumercode as \"consumerCode\", (select name from '"$1"'.eg_city) as \"cityName\", (select districtname from '"$1"'.eg_city) as \"districtName\", (select regionname from '"$1"'.eg_city) as \"regionName\", status.description as \"status\",DATE(ch.receiptdate) as \"receiptDate\", (select trim(\u0027Water Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber =  (select min(ordernumber) from '"$1"'.egcl_collectiondetails where collectionheader=ch.id)) as \"installmentFrom\", (select trim(\u0027Water Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber=(select max(ordernumber) from '"$1"'.egcl_collectiondetails where cramount> 0 and collectionheader=ch.id)) as \"installmentTo\", ch.payeename as \"consumerName\", (select grade from '"$1"'.eg_city) as \"cityGrade\", (select code from '"$1"'.eg_city) as \"cityCode\",eu.name as \"receiptCreator\",(select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"id\", block.name as \"block\", locality.name as \"locality\" , ch.consumertype as \"consumerType\" from '"$1"'.egcl_collectionheader ch,'"$1"'.egcl_servicedetails billingservice, '"$1"'.egcl_collectioninstrument ci, '"$1"'.egf_instrumentheader ih, '"$1"'.egf_instrumenttype it, '"$1"'.egcl_onlinepayments op, '"$1"'.egcl_servicedetails paymentservice, '"$1"'.egw_status status,  '"$1"'.eg_user eu,  '"$1"'.eg_boundary locality, '"$1"'.eg_boundary block, '"$1"'.egwtr_connection wtrcon  where billingservice.id=ch.servicedetails and ci.collectionheader=ch.id and ci.instrumentheader=ih.id and ih.instrumenttype=it.id and ch.id=op.collectionheader and op.servicedetails=paymentservice.id and ch.status=status.id and ch.collectiontype=\u0027O\u0027 and billingservice.code=\u0027WT\u0027 and wtrcon.consumercode=ch.consumercode and ch.createdby=eu.id and ch.status in (select id from '"$1"'.egw_status where moduletype=\u0027ReceiptHeader\u0027 and code not in (\u0027PENDING\u0027,\u0027FAILED\u0027)) and locality.id=wtrcon.locality and block.id=wtrcon.block UNION select (select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"_id\", DATE(ch.createddate) as \"createdDate\", ch.receiptNumber as \"receiptNumber\", billingservice.name as \"billingService\", it.type as \"paymentMode\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ARREAR_AMOUNT\u0027) as \"arrearAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_LATEPAYMENT_CHARGES\u0027,\u0027CURRENT_LATEPAYMENT_CHARGES\u0027)) as \"latePaymentCharges\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_PENALTY_CHARGES\u0027,\u0027CURRENT_PENALTY_CHARGES\u0027)) as \"interestAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027CURRENT_AMOUNT\u0027) as \"currentAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ADVANCE_AMOUNT\u0027) as \"advanceAmount\",ch.totalamount as \"totalAmount\", ch.source as \"channel\",\u0027\u0027 as \"paymentGateway\",ch.referencenumber as \"billNumber\", ch.consumercode as \"consumerCode\", (select name from '"$1"'.eg_city) as \"cityName\", (select districtname from '"$1"'.eg_city) as \"districtName\", (select regionname from '"$1"'.eg_city) as \"regionName\",status.description as \"status\",DATE(ch.receiptdate) as \"receiptDate\",(select trim(\u0027Sewerage Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber= (select min(ordernumber) from '"$1"'.egcl_collectiondetails where collectionheader=ch.id)) as \"installmentFrom\", (select trim(\u0027Sewerage Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber=(select max(ordernumber) from '"$1"'.egcl_collectiondetails where cramount>0 and collectionheader=ch.id)) as \"installmentTo\",ch.payeename as \"consumerName\", (select grade from '"$1"'.eg_city) as \"cityGrade\", (select code from '"$1"'.eg_city) as \"cityCode\", eu.name as \"receiptCreator\",(select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"id\", block.name as \"block\", locality.name as \"locality\" , ch.consumertype as \"consumerType\" from '"$1"'.egcl_collectionheader ch, '"$1"'.egcl_servicedetails billingservice, '"$1"'.egcl_collectioninstrument ci, '"$1"'.egf_instrumentheader ih, '"$1"'.egf_instrumenttype it, '"$1"'.egw_status status, '"$1"'.eg_user eu,  '"$1"'.eg_boundary locality, '"$1"'.eg_boundary block, '"$1"'.egswtax_connection swrcon where billingservice.id=ch.servicedetails and ci.collectionheader=ch.id and ci.instrumentheader=ih.id and ih.instrumenttype=it.id and ch.status=status.id and ch.collectiontype in (\u0027C\u0027,\u0027F\u0027) and billingservice.code=\u0027STAX\u0027 and swrcon.shsc_number=ch.consumercode and ch.createdby=eu.id and ch.status in (select id from '"$1"'.egw_status where moduletype=\u0027ReceiptHeader\u0027 and code not in (\u0027PENDING\u0027,\u0027FAILED\u0027)) and locality.id=swrcon.locality and block.id=swrcon.block UNION select (select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"_id\", DATE(ch.createddate) as \"createdDate\", ch.receiptNumber as \"receiptNumber\",billingservice.name as \"billingService\", it.type as \"paymentMode\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ARREAR_AMOUNT\u0027) as \"arrearAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_LATEPAYMENT_CHARGES\u0027,\u0027CURRENT_LATEPAYMENT_CHARGES\u0027)) as \"latePaymentCharges\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose in (\u0027ARREAR_PENALTY_CHARGES\u0027,\u0027CURRENT_PENALTY_CHARGES\u0027)) as \"interestAmount\", (select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027CURRENT_AMOUNT\u0027) as \"currentAmount\",(select sum(cramount) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader  and colld.purpose =\u0027ADVANCE_AMOUNT\u0027) as \"advanceAmount\", ch.totalamount as \"totalAmount\",ch.source as \"channel\",paymentservice.name as \"paymentGateway\",ch.referencenumber as \"billNumber\", ch.consumercode as \"consumerCode\", (select name from '"$1"'.eg_city) as \"cityName\", (select districtname from '"$1"'.eg_city) as \"districtName\", (select regionname from '"$1"'.eg_city) as \"regionName\", status.description as \"status\",DATE(ch.receiptdate) as \"receiptDate\", (select trim(\u0027Sewerage Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber =  (select min(ordernumber) from '"$1"'.egcl_collectiondetails where collectionheader=ch.id)) as \"installmentFrom\", (select trim(\u0027Sewerage Charges -\u0027 from left(colld.description,27)) from '"$1"'.egcl_collectiondetails colld where ch.id=colld.collectionheader and colld.ordernumber=(select max(ordernumber) from '"$1"'.egcl_collectiondetails where cramount> 0 and collectionheader=ch.id)) as \"installmentTo\", ch.payeename as \"consumerName\", (select grade from '"$1"'.eg_city) as \"cityGrade\", (select code from '"$1"'.eg_city) as \"cityCode\",eu.name as \"receiptCreator\",(select code from '"$1"'.eg_city)||\u0027_\u0027||ch.receiptNumber as \"id\", block.name as \"block\", locality.name as \"locality\" , ch.consumertype as \"consumerType\" from '"$1"'.egcl_collectionheader ch,'"$1"'.egcl_servicedetails billingservice, '"$1"'.egcl_collectioninstrument ci, '"$1"'.egf_instrumentheader ih, '"$1"'.egf_instrumenttype it, '"$1"'.egcl_onlinepayments op, '"$1"'.egcl_servicedetails paymentservice, '"$1"'.egw_status status,  '"$1"'.eg_user eu,  '"$1"'.eg_boundary locality, '"$1"'.eg_boundary block, '"$1"'.egswtax_connection swrcon  where billingservice.id=ch.servicedetails and ci.collectionheader=ch.id and ci.instrumentheader=ih.id and ih.instrumenttype=it.id and ch.id=op.collectionheader and op.servicedetails=paymentservice.id and ch.status=status.id and ch.collectiontype=\u0027O\u0027 and billingservice.code=\u0027STAX\u0027 and swrcon.shsc_number=ch.consumercode and ch.createdby=eu.id and ch.status in (select id from '"$1"'.egw_status where moduletype=\u0027ReceiptHeader\u0027 and code not in (\u0027PENDING\u0027,\u0027FAILED\u0027)) and locality.id=swrcon.locality and block.id=swrcon.block",
"index": "receipts",
"type": "receipts_bifurcation",
"elasticsearch" : {
     "cluster" : "punjab-prod-es-cluster",
     "host" : "localhost",
     "port" : 9300
}
    }   
}' | java \
-cp "${lib}/*" \
-Dlog4j.configurationFile=${bin}/log4j2.xml \
org.xbib.tools.Runner \
org.xbib.tools.JDBCImporter

